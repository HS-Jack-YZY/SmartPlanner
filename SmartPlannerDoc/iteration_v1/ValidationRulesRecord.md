# SmartPlanner 数据验证规则记录

## 文档说明

### 更新记录
| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 2024/12/17 | v1.0 | 初始版本 | @HS_Jack_YZY |
| 2024/12/17 | v1.1 | 补充完整属性验证规则 | @HS_Jack_YZY |
| 2024/12/17 | v1.2 | 更新规则以匹配CoreData模型变更 | @HS_Jack_YZY |

### 文档目的
- 记录所有数据验证规则的实现状态
- 追踪验证规则的变更历史
- 确保验证规则的一致性
- 便于团队成员理解和维护

## 验证规则总览

### PlanCategory（计划类别）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 已实现 | 2024/12/17 | 系统自动生成 |
| name | 必填，1-100字符 | 高 | 已实现 | 2024/12/17 | 用户界面显示名称 |
| color | 必填，有效的颜色代码，默认#808080FF | 中 | 已实现 | 2024/12/17 | 格式：#RRGGBB或#RRGGBBAA |
| level | 必填，0-5的整数，默认0 | 高 | 已实现 | 2024/12/17 | 0表示顶级类别 |
| path | 可选，最大255字符 | 中 | 已实现 | 2024/12/17 | 完整类别路径 |
| isVisible | 必填，布尔值，默认true | 高 | 已实现 | 2024/12/17 | 显示控制 |
| displayOrder | 必填，非负整数，默认0 | 低 | 已实现 | 2024/12/17 | 显示排序 |
| createdAt | 必填，不能是未来时间 | 高 | 已实现 | 2024/12/17 | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 已实现 | 2024/12/17 | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 已实现 | 2024/12/17 | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| parent | 可选，单一关系 | 高 | 已实现 | 2024/12/17 | 父类别引用 |
| children | 可选，多重关系，级联删除 | 高 | 已实现 | 2024/12/17 | 子类别集合 |
| planTemplates | 可选，多重关系，级联删除 | 中 | 已实现 | 2024/12/17 | 关联的计划模板 |

### PlanBlockTemplate（计划区间模板）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 已实现 | 2024/12/17 | 系统自动生成 |
| name | 必填，1-100字符 | 高 | 已实现 | 2024/12/17 | 区间模板名称 |
| color | 必填，有效的颜色代码，默认#808080FF | 中 | 已实现 | 2024/12/17 | 显示颜色 |
| desc | 可选，文本 | 低 | 已实现 | 2024/12/17 | 区间描述 |
| isVisible | 必填，布尔值，默认true | 高 | 已实现 | 2024/12/17 | 显示控制 |
| createdAt | 必填，不能是未来时间 | 高 | 已实现 | 2024/12/17 | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 已实现 | 2024/12/17 | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 已实现 | 2024/12/17 | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| blockInstances | 可选，多重关系，级联删除 | 中 | 已实现 | 2024/12/17 | 区间实例集合 |

### PlanTemplate（计划模板）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 已实现 | 2024/12/17 | 系统自动生成 |
| name | 必填，1-100字符 | 高 | 已实现 | 2024/12/17 | 计划模板名称 |
| color | 必填，有效的颜色代码，默认#808080FF | 中 | 已实现 | 2024/12/17 | 显示颜色 |
| isFixedTime | 必填，布尔值，默认false | 高 | 已实现 | 2024/12/17 | 时间固定标记 |
| isReminderEnabled | 必填，布尔值，默认true | 高 | 已实现 | 2024/12/17 | 提醒开关 |
| reminderTime | 必填，0-1440整数，默认0 | 中 | 已实现 | 2024/12/17 | 提前提醒时间 |
| priority | 必填，0-5整数，默认0 | 中 | 已实现 | 2024/12/17 | 优先级 |
| difficulty | 必填，0-5整数，默认0 | 中 | 已实现 | 2024/12/17 | 难度等级 |
| tags | 可选，JSON格式 | 低 | 已实现 | 2024/12/17 | 标签 |
| createdAt | 必填，不能是未来时间 | 高 | 已实现 | 2024/12/17 | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 已实现 | 2024/12/17 | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 已实现 | 2024/12/17 | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| planCategory | 可选，单一关系 | 高 | 已实现 | 2024/12/17 | 关联的类别 |
| planInstances | 可选，多重关系，级联删除 | 中 | 已实现 | 2024/12/17 | 计划实例集合 |

### PlanInstance（计划实例）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 已实现 | 2024/12/17 | 系统自动生成 |
| startTime | 必填，有效时间戳 | 高 | 已实现 | 2024/12/17 | 开始时间 |
| endTime | 必填，晚于startTime | 高 | 已实现 | 2024/12/17 | 结束时间 |
| duration | 必填，正整数，默认0 | 高 | 已实现 | 2024/12/17 | 持续时长 |
| isReminderEnabled | 必填，布尔值，默认true | 高 | 已实现 | 2024/12/17 | 提醒开关 |
| reminderTime | 必填，0-1440整数，默认0 | 中 | 已实现 | 2024/12/17 | 提醒时间 |
| priority | 必填，0-5整数，默认0 | 中 | 已实现 | 2024/12/17 | 优先级 |
| difficulty | 必填，0-5整数，默认0 | 中 | 已实现 | 2024/12/17 | 难度等级 |
| createdAt | 必填，不能是未来时间 | 高 | 已实现 | 2024/12/17 | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 已实现 | 2024/12/17 | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 已实现 | 2024/12/17 | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| planTemplate | 必填，单一关系 | 高 | 已实现 | 2024/12/17 | 关联的计划模板 |
| blockInstance | 必填，单一关系 | 高 | 已实现 | 2024/12/17 | 所属的区间实例 |

## 业务规则验证

### 时间冲突检测
| 规则描述 | 优先级 | 状态 | 最后更新 | 备注 |
|----------|--------|------|----------|------|
| 同一时间段不能有重叠计划 | 高 | 已实现 | 2024/12/17 | 需考虑时区 |
| 计划区间时间范围验证（6:00-22:00） | 中 | 已实现 | 2024/12/17 | 默认工作时间范围 |
| 计划时间范围验证（8:00-20:00） | 中 | 已实现 | 2024/12/17 | 默认计划时间范围 |
| 实例时间必须在区间范围内 | 高 | 已实现 | 2024/12/17 | 计划实例的时间必须在其所属区间的时间范围内 |

### 数据完整性验证
| 规则描述 | 优先级 | 状态 | 最后更新 | 备注 |
|----------|--------|------|----------|------|
| 类别层级最大深度限制 | 高 | 已实现 | 2024/12/17 | 最大5层 |
| 类别循环引用检测 | 高 | 已实现 | 2024/12/17 | 防止死循环 |
| 删除操作级联验证 | 高 | 已实现 | 2024/12/17 | 检查关联数据 |
| 软删除数据一致性 | 中 | 已实现 | 2024/12/17 | 关联数据状态 |
| UUID唯一性验证 | 高 | 已实现 | 2024/12/17 | 确保ID不重复 |

### 值范围验证
| 规则描述 | 优先级 | 状态 | 最后更新 | 备注 |
|----------|--------|------|----------|------|
| 优先级范围（0-5） | 中 | 已实现 | 2024/12/17 | 所有实体通用 |
| 难度等级范围（0-5） | 中 | 已实现 | 2024/12/17 | 所有实体通用 |
| 提醒时间范围（0-1440） | 中 | 已实现 | 2024/12/17 | 最多提前24小时 |
| 名称长度（1-100） | 高 | 已实现 | 2024/12/17 | 所有实体通用 |
| 颜色格式验证 | 中 | 已实现 | 2024/12/17 | #RRGGBB或#RRGGBBAA |

## 验证规则变更记录

### 变更历史
| 日期 | 规则 | 变更内容 | 原因 | 影响范围 | 更新人 |
|------|------|----------|------|-----------|--------|
| 2024/12/17 | 所有规则 | 初始定义 | 项目启动 | 全部 | @HS_Jack_YZY |
| 2024/12/17 | 颜色属性 | 改为必填，添加默认值 | 简化验证逻辑 | 所有实体 | @HS_Jack_YZY |
| 2024/12/17 | 名称长度 | 统一设置为1-100 | 统一规范 | 所有实体 | @HS_Jack_YZY |
| 2024/12/17 | 数值范围 | 更新默认值和范围 | 完善验证规则 | 相关属性 | @HS_Jack_YZY |

## 验证规则测试状态

### 单元测试覆盖
| 规则类别 | 测试用例数 | 覆盖率 | 状态 | 最后更新 |
|----------|------------|--------|------|----------|
| 基础字段验证 | 50 | 80% | 进行中 | 2024/12/17 |
| 关系验证 | 30 | 70% | 进行中 | 2024/12/17 |
| 业务规则验证 | 40 | 75% | 进行中 | 2024/12/17 |

### 集成测试覆盖
| 测试场景 | 测试用例数 | 覆盖率 | 状态 | 最后更新 |
|----------|------------|--------|------|----------|
| 跨实体验证 | 20 | 60% | 进行中 | 2024/12/17 |
| 并发操作 | 15 | 50% | 进行中 | 2024/12/17 |
| 性能测试 | 10 | 40% | 进行中 | 2024/12/17 |

## 实现注意事项

### 性能考虑
1. **验证缓存**
   - 缓存验证结果
   - 设置合理的缓存时间
   - 及时清理无效缓存

2. **批量验证优化**
   - 减少数据库查询
   - 使用批量操作
   - 优化验证顺序

### 错误处理
1. **错误分类**
   - 字段验证错误
   - 关系验证错误
   - 业务规则违反
   - 系统错误

2. **错误恢复**
   - 提供清晰的错误信息
   - 支持部分验证
   - 保留有效数据

### 可扩展性
1. **验证规则扩展**
   - 支持自定义验证
   - 允许规则组合
   - 便于添加新规则

2. **验证框架扩展**
   - 插件式架构
   - 支持第三方验证
   - 版本兼容处理

## 参考文档

### 内部文档
- DataValidationImplementationPlan.md
- Development_Progress.md
- CodingPrinciples.md

### 外部资源
- [Core Data Validation](https://developer.apple.com/documentation/coredata/nsmanagedobject/1506699-validate)
- [Swift API Design Guidelines](https://swift.org/documentation/api-design-guidelines/) 