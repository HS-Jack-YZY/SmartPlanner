# SmartPlanner 数据验证规则记录

## 文档说明

### 更新记录
| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 2024/12/17 | v1.0 | 初始版本 | @HS_Jack_YZY |
| 2024/12/17 | v1.1 | 补充完整属性验证规则 | @HS_Jack_YZY |

### 文档目的
- 记录所有数据验证规则的实现状态
- 追踪验证规则的变更历史
- 确保验证规则的一致性
- 便于团队成员理解和维护

## 验证规则总览

### PlanCategory（计划类别）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 待实现 | - | 系统自动生成 |
| name | 必填，1-100字符，不允许纯空格 | 高 | 待实现 | - | 用户界面显示名称 |
| color | 可选，有效的颜色代码 | 中 | 待实现 | - | 格式：#RRGGBB或#RRGGBBAA |
| level | 必填，0-5的整数 | 高 | 待实现 | - | 0表示顶级类别 |
| path | 可选，最大255字符 | 中 | 待实现 | - | 完整类别路径 |
| isVisible | 必填，布尔值 | 高 | 待实现 | - | 默认为true |
| displayOrder | 可选，非负整数 | 低 | 待实现 | - | 显示排序 |
| createdAt | 必填，不能是未来时间 | 高 | 待实现 | - | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 待实现 | - | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 待实现 | - | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| parent | 可选，单一关系 | 高 | 待实现 | - | 父类别引用 |
| children | 可选，多重关系 | 高 | 待实现 | - | 子类别集合 |
| planTemplates | 可选，多重关系 | 中 | 待实现 | - | 关联的计划模板 |

### PlanBlockTemplate（计划区间模板）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 待实现 | - | 系统自动生成 |
| name | 必填，1-100字符 | 高 | 待实现 | - | 区间模板名称 |
| color | 可选，有效的颜色代码 | 中 | 待实现 | - | 显示颜色 |
| desc | 可选，文本 | 低 | 待实现 | - | 区间描述 |
| isVisible | 必填，布尔值 | 高 | 待实现 | - | 默认为true |
| createdAt | 必填，不能是未来时间 | 高 | 待实现 | - | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 待实现 | - | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 待实现 | - | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| blockInstances | 可选，多重关系 | 中 | 待实现 | - | 区间实例集合 |

### PlanBlockInstance（计划区间实例）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 待实现 | - | 系统自动生成 |
| startAt | 必填，有效时间戳 | 高 | 待实现 | - | 开始时间 |
| endAt | 必填，晚于startAt | 高 | 待实现 | - | 结束时间 |
| createdAt | 必填，不能是未来时间 | 高 | 待实现 | - | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 待实现 | - | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 待实现 | - | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| blockTemplate | 必填，单一关系 | 高 | 待实现 | - | 关联的区间模板 |
| planInstances | 可选，多重关系 | 中 | 待实现 | - | 包含的计划实例 |

### PlanTemplate（计划模板）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 待实现 | - | 系统自动生成 |
| name | 必填，1-100字符 | 高 | 待实现 | - | 计划模板名称 |
| color | 可选，有效的颜色代码 | 中 | 待实现 | - | 显示颜色 |
| isFixedTime | 必填，布尔值 | 高 | 待实现 | - | 默认为false |
| isReminderEnabled | 必填，布尔值 | 高 | 待实现 | - | 默认为true |
| reminderTime | 可选，整数（分钟） | 中 | 待实现 | - | 提前提醒时间 |
| priority | 可选，1-5整数 | 中 | 待实现 | - | 优先级 |
| difficulty | 可选，1-5整数 | 中 | 待实现 | - | 难度等级 |
| tags | 可选，文本 | 低 | 待实现 | - | 标签（JSON格式） |
| createdAt | 必填，不能是未来时间 | 高 | 待实现 | - | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 待实现 | - | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 待实现 | - | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| planCategory | 可选，单一关系 | 高 | 待实现 | - | 关联的类别 |
| planInstances | 可选，多重关系 | 中 | 待实现 | - | 计划实例集合 |

### PlanInstance（计划实例）

#### 基础字段验证
| 字段名 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|--------|----------|--------|------|----------|------|
| id | 必填，唯一UUID | 高 | 待实现 | - | 系统自动生成 |
| startTime | 必填，有效时间戳 | 高 | 待实现 | - | 开始时间 |
| endTime | 必填，晚于startTime | 高 | 待实现 | - | 结束时间 |
| duration | 必填，正整数（分钟） | 高 | 待实现 | - | 持续时长 |
| isReminderEnabled | 必填，布尔值 | 高 | 待实现 | - | 默认为true |
| reminderTime | 可选，整数（分钟） | 中 | 待实现 | - | 提醒时间 |
| priority | 可选，1-5整数 | 中 | 待实现 | - | 优先级 |
| difficulty | 可选，1-5整数 | 中 | 待实现 | - | 难度等级 |
| createdAt | 必填，不能是未来时间 | 高 | 待实现 | - | 创建时自动设置 |
| updatedAt | 必填，不能早于createdAt | 高 | 待实现 | - | 更新时自动更新 |
| deletedAt | 可选，时间戳 | 中 | 待实现 | - | 软删除标记 |

#### 关系验证
| 关系 | 验证规则 | 优先级 | 状态 | 最后更新 | 备注 |
|------|----------|--------|------|----------|------|
| planTemplate | 必填，单一关系 | 高 | 待实现 | - | 关联的计划模板 |
| blockInstance | 必填，单一关系 | 高 | 待实现 | - | 所属的区间实例 |

## 业务规则验证

### 时间冲突检测
| 规则描述 | 优先级 | 状态 | 最后更新 | 备注 |
|----------|--------|------|----------|------|
| 同一时间段不能有重叠计划 | 高 | 待实现 | - | 需考虑时区 |
| 计划区间时间范围验证（6:00-22:00） | 中 | 待实现 | - | 默认工作时间范围，可在设置中修改 |
| 计划时间范围验证（8:00-20:00） | 中 | 待实现 | - | 默认计划时间范围，可在设置中修改 |
| 实例时间必须在区间范围内 | 高 | 待实现 | - | 计划实例的时间必须在其所属区间的时间范围内 |

### 数据完整性验证
| 规则描述 | 优先级 | 状态 | 最后更新 | 备注 |
|----------|--------|------|----------|------|
| 类别层级最大深度限制 | 高 | 待实现 | - | 最大5层 |
| 类别循环引用检测 | 高 | 待实现 | - | 防止死循环 |
| 删除操作级联验证 | 高 | 待实现 | - | 检查关联数据 |
| 软删除数据一致性 | 中 | 待实现 | - | 关联数据状态 |
| UUID唯一性验证 | 高 | 待实现 | - | 确保ID不重复 |
| 数据版本控制 | 高 | 待实现 | - | 防止并发冲突 |

### 值范围验证
| 规则描述 | 优先级 | 状态 | 最后更新 | 备注 |
|----------|--------|------|----------|------|
| 优先级范围（1-5） | 中 | 待实现 | - | 所有实体通用 |
| 难度等级范围（1-5） | 中 | 待实现 | - | 所有实体通用 |
| 提醒时间有效范围 | 中 | 待实现 | - | 需定义范围 |
| 持续时间最大值（24h） | 高 | 待实现 | - | 1440分钟 |

## 验证规则变更记录

### 变更历史
| 日期 | 规则 | 变更内容 | 原因 | 影响范围 | 更新人 |
|------|------|----------|------|-----------|--------|
| 2024/01/20 | 所有规则 | 初始定义 | 项目启动 | 全部 | @HS_Jack_YZY |

### 待定规则
| 规则描述 | 提议人 | 状态 | 备注 |
|----------|--------|------|------|
| 添加计划优先级验证 | @HS_Jack_YZY | 讨论中 | 需确定优先级范围 |
| 增加标签验证规则 | @HS_Jack_YZY | 待评估 | 标签系统待设计 |

## 验证规则测试状态

### 单元测试覆盖
| 规则类别 | 测试用例数 | 覆盖率 | 状态 | 最后更新 |
|----------|------------|--------|------|----------|
| 基础字段验证 | 0 | 0% | 未开始 | - |
| 关系验证 | 0 | 0% | 未开始 | - |
| 业务规则验证 | 0 | 0% | 未开始 | - |

### 集成测试覆盖
| 测试场景 | 测试用例数 | 覆盖率 | 状态 | 最后更新 |
|----------|------------|--------|------|----------|
| 跨实体验证 | 0 | 0% | 未开始 | - |
| 并发操作 | 0 | 0% | 未开始 | - |
| 性能测试 | 0 | 0% | 未开始 | - |

## 实现注意事项

### 性能考虑
1. **验证缓存**
   - 缓存验证结果
   - 设置合理的缓存时间
   - 及时清理无效缓存

2. **批量验证优化**
   - 减少数据库查询
   - 使用批量操作
   - 优化验证顺序

### 错误处理
1. **错误分类**
   - 字段验证错误
   - 关系验证错误
   - 业务规则违反
   - 系统错误

2. **错误恢复**
   - 提供清晰的错误信息
   - 支持部分验证
   - 保留有效数据

### 可扩展性
1. **验证规则扩展**
   - 支持自定义验证
   - 允许规则组合
   - 便于添加新规则

2. **验证框架扩展**
   - 插件式架构
   - 支持第三方验证
   - 版本兼容处理

## 参考文档

### 内部文档
- DataValidationImplementationPlan.md
- Development_Progress.md
- CodingPrinciples.md

### 外部资源
- [Core Data Validation](https://developer.apple.com/documentation/coredata/nsmanagedobject/1506699-validate)
- [Swift API Design Guidelines](https://swift.org/documentation/api-design-guidelines/) 